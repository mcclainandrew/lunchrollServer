from app import app
from flask import request, Response, session, abort, jsonify, render_template, g
import json
import requests
import sqlite3
from passlib.hash import md5_crypt

placesApiKey = "AIzaSyD7Dxn7cpZ2q70mDr3Ia5stmPrcydNgh0w"
nearbySearch = "https://maps.googleapis.com/maps/api/place/nearbysearch/json"
textSearch = "https://maps.googleapis.com/maps/api/place/textsearch/json"
headers = {'Content-Type':'application/json'}
app.debug = True

#Start Api Help Page

@app.route('/')
@app.route('/index')
@app.route('/help')
@app.route('/help/<name>')
def help(name=None):
    return render_template("apihelp.html", name=name) 

@app.route('/help/client/nearbyAny')
@app.route('/help/client/nearbyAny/<name>')
def helpNearbyAny(name=None):
    return render_template("nearbyAny.html", name=name)

@app.route('/help/client/nearbySpecific')
@app.route('/help/client/nearbySpecific/<name>')
def helpNearbySpecific(name=None):
    return render_template("nearbySpecific.html", name=name)

@app.route('/help/client/nearbySuggested')
@app.route('/help/client/nearbySuggested/<name>')
def helpNearbySuggested(name=None):
    return render_template("nearbySuggested.html", name=name)

#End Api Help Page

#Start Client Calls

@app.route('/client/nearbySpecific', methods=['POST'])
def searchSpecific():
    data_dict = request.get_json()
    latitude = data_dict['latitude']
    longitude = data_dict['longitude']
    location = latitude + ',' + longitude
    genre = data_dict['genre']
    genre = genre + '+food'
    payload = {'location': location, 'radius': 5000, 'types': "food|restaurant", 'query': genre, 'key': placesApiKey}
    r = requests.post(textSearch, params=payload, headers=headers);
    return Response(r.text, content_type='application/json')
    
@app.route('/client/nearbySuggested', methods=['POST'])
       
@app.route('/client/nearbyAny', methods=['POST'])
def searchNearby():
    data_dict = request.get_json()

    latitude = data_dict['latitude']
    longitude = data_dict['longitude']
    location = latitude + "," + longitude 
    payload = {'location': location, 'radius': 5000, 'types': 'food', 'key': placesApiKey}

    r = requests.post(nearbySearch, params=payload, headers=headers)
    return Response(r.text, content_type="application/json")

#End Client Calls

#Start Database Calls

@app.route('/user/updateUser', methods = ['POST'])
def new_user():
    db = get_db()
    data_dict = request.get_json()
    userID = data_dict['userID'] + ""
    username = data_dict['username'] + ""
    password = data_dict['password'] + ""
    email = data_dict['email'] + ""
    
    if userID == '0':
	encryptedPass = md5_crypt.encrypt(password)
        db.execute("insert into Users (username, password, email) values (?, ?, ?)", [username, password, email])
        db.commit()
    cur = db.execute("SELECT userID, username, password, email FROM Users WHERE email = (?)", [email])
    db.commit()
    entries = [dict(userID=row[0], username=row[1], password=row[2], email=row[3]) for row in cur.fetchall()]

    return jsonify(data=entries[-1])

@app.route('/group/updateGroup', methods = ['POST'])
def updateGroup():    
    db = get_db()
    data_dict = request.get_json()
    groupID = data_dict['groupID'] + ""
    userID = data_dict['userID'] + ""
    name = data_dict['name'] + ""
    users = data_dict['users'] + ""

    if groupID == '0':
        db.execute("INSERT INTO Groups (userID, name, users) VALUES (?, ?, ?)", [userID, name, users])
        db.commit()
    cur = db.execute("SELECT groupID, userID, name, users FROM Groups WHERE name = (?)", [name])
    db.commit()
    entries = [dict(groupID=row[0], userID=row[1], name=row[2], users=row[3]) for row in cur.fetchall()]
    return jsonify(data=entries)

@app.route('/user/getData', methods = ['POST'])
def getUserData():
    db = get_db()
    data_dict = request.get_json()
    userID = data_dict['userID']
    cur = db.execute("SELECT username, password, email FROM Users WHERE userID = (?)", [userID])
    db.commit()
    entries = [dict(userID=userID, username=row[0], password=row[1], email=row[2]) for row in cur.fetchall()]
    return jsonify(data=entries)   

@app.route('/group/getData', methods = ['POST'])
def getGroupData():
    db = get_db()
    data_dict = request.get_json()
    groupID = data_dict['groupID']
    cur = db.execute("SELECT userID, name, users FROM Groups WHERE groupID = (?)", [groupID])
    db.commit()
    entries = [dict(groupID=groupID, userID=row[0], name=row[1], users=row[2]) for row in cur.fetchall()]
    return jsonify(data=entries)

@app.route('/user/updatePreferences', methods = ['POST'])
def updatePreferences():
    db = get_db()
    data_dict = request.get_json()
    userID = data_dict['userID'] + ""
    asian = data_dict['asian'] + ""
    american = data_dict['amerian'] + ""
    italian = data_dict['italian'] + ""
    mexican = data_dict['mexican'] + ""
    indian = data_dict['indian'] + ""
    genrePreferenceID = data_dict['genrePreferenceID']
    if genrePrefernceID == '0':
        db.execute("INSERT INTO GenrePreferences (asian, american, italian, mexican, indian) VALUES (?, ?, ?, ?, ?)", [asian, american, italian, mexican, indian])
        db.commit()
    else:
        db.execute("SELECT Preferences SET(
        db.execute("UPDATE GenrePreferences SET (asian=?, american=?, italian=?, mexican=?, indian=?) WHERE GroupID = (?)", 
            [asian,american,italian,mexican,indian,groupID])
        db.commit()
    cur = db.execute("")
#todo

@app.route('/user/login', methods = ['POST'])
def login():
    db = get_db()
    data_dict = request.get_json()
    email = data_dict['email'] + ""
    password = data_dict['password'] + ""
    encryptedPass = md5_crypt.encrypt(password)

    cur = db.execute("SELECT * FROM Users WHERE email = ? AND password = ?", [email, password])
    db.commit()
    entries = [dict(userID=row[0], username=row[1]) for row in cur.fetchall()]
    return jsonify(data=entries)         


@app.teardown_appcontext
def teardown_request(exception):
    if hasattr(g, 'db'):
        g.db.close()

def get_db():
    if not hasattr(g, 'db'):
        g.db = connect_db()
        g.db.row_factory = sqlite3.Row
    return g.db
    
def connect_db():
    return sqlite3.connect('/var/www/lunchroll/app/database/lunchroll.db')

#End Database Calls

