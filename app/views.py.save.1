from app import app
from flask import request, Response, session, abort, render_template, g
import json
import requests
import sqlite3
from passlib.hash import md5_crypt

placesApiKey = "AIzaSyD7Dxn7cpZ2q70mDr3Ia5stmPrcydNgh0w"
nearbySearch = "https://maps.googleapis.com/maps/api/place/nearbysearch/json"
textSearch = "https://maps.googleapis.com/maps/api/place/textsearch/json"
headers = {'Content-Type':'application/json'}
DATABASE = './lunchroll.db'
app.debug = 0

@app.before_request
def before_request:
    g.db = sqlite3.connect(DATABASE)

@app.teardown_request
def teardown_request:
    if hasattr(g, 'db'):
	g.db.close()

@app.route('/')
@app.route('/index')
@app.route('/help')
@app.route('/help/<name>')
def help(name=None):
    return render_template("apihelp.html", name=name) 

@app.route('/help/client/nearbyAny')
@app.route('/help/client/nearbyAny/<name>')
def helpNearbyAny(name=None):
    return render_template("nearbyAny.html", name=name)

@app.route('/help/client/nearbySpecific')
@app.route('/help/client/nearbySpecific/<name>')
def helpNearbySpecific(name=None):
    return render_template("nearbySpecific.html", name=name)

@app.route('/help/client/nearbySuggested')
@app.route('/help/client/nearbySuggested/<name>')
def helpNearbySuggested(name=None):
    return render_template("nearbySuggested.html", name=name)

@app.route('/client/nearbySpecific', methods=['POST'])
def searchSpecific():
    data_dict = request.get_json()
    latitude = data_dict['latitude']
    longitude = data_dict['longitude']
    location = latitude + ',' + longitude
    genre = data_dict['genre']
    genre = genre + '+food'
    payload = {'location': location, 'radius': 5000, 'types': "food|restaurant", 'query': genre, 'key': placesApiKey}
    r = requests.post(textSearch, params=payload, headers=headers);
    return Response(r.text, content_type='application/json')
    
@app.route('/client/nearbySuggested', methods=['POST'])
       
@app.route('/client/nearbyAny', methods=['POST'])
def searchNearby():
    data_dict = request.get_json()

    latitude = data_dict['latitude']
    longitude = data_dict['longitude']
    location = latitude + "," + longitude 
    payload = {'location': location, 'radius': 5000, 'types': 'food', 'key': placesApiKey}

    r = requests.post(nearbySearch, params=payload, headers=headers)
    return Response(r.text, content_type="application/json")

@app.route('/user/updateUser', methods = ['POST'])
def new_user():
    data_dict = request.get_json()

    username = data_dict['username']
    password = data_dict['password']
    userID = data_dict['userID']
    newPass = data_dict['newPass']
    newGroup = data_dict['newGroup']
    
    if username is None or password is None:
        abort(400) # missing arguments
    if userID is None:
    	g.db.execute("INSERT INTO username VALUES (?)", username);
    	g.db.execute("INSERT INTO password VALUES (?)", md5_crypt.encrypt(password));
    	g.db.commit()
    else
    	if 	
    return None
@app.route('/user/updateUser', methods = ['POST'])

@app.route('/group/updateGroup', methods = ['POST'])

@app.route('/user/getData', methods = ['POST'])

@app.route('/group/getData', methods = ['POST'])

def temp():

    return request.get_json()
